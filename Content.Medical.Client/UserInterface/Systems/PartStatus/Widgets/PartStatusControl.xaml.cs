// SPDX-License-Identifier: AGPL-3.0-or-later
using Content.Medical.Common.Targeting;
using Content.Medical.Common.Wounds;
using Content.Medical.Shared.Wounds;
using Content.Shared.Body;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;
using Robust.Client.Input;
using Robust.Client.UserInterface;
using Robust.Shared.Input;
using Robust.Shared.Prototypes;
using Robust.Shared.Timing;

namespace Content.Medical.Client.UserInterface.Systems.PartStatus.Widgets;

[GenerateTypedNameReferences]
public sealed partial class PartStatusControl : UIWidget
{
    [Dependency] private readonly IGameTiming _timing = default!;

    private readonly Dictionary<ProtoId<OrganCategoryPrototype>, TextureRect> _partStatusControls;
    private readonly PartStatusUIController _controller;

    public PartStatusControl()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _controller = UserInterfaceManager.GetUIController<PartStatusUIController>();
        _partStatusControls = new Dictionary<ProtoId<OrganCategoryPrototype>, TextureRect>
        {
            { "Head", DollHead },
            { "Torso", DollTorso },
            { "ArmLeft", DollLeftArm },
            { "HandLeft", DollLeftHand },
            { "ArmRight", DollRightArm },
            { "HandRight", DollRightHand },
            { "LegLeft", DollLeftLeg },
            { "FootLeft", DollLeftFoot },
            { "LegRight", DollRightLeg },
            { "FootRight", DollRightFoot },
        };
        MouseFilter = MouseFilterMode.Stop;
        OnKeyBindDown += OnClicked;
    }

    public void SetTextures(Dictionary<ProtoId<OrganCategoryPrototype>, WoundableSeverity> state)
    {
        foreach (var (part, integrity) in state)
        {
            if (!_partStatusControls.TryGetValue(part, out var button))
                continue;

            var name = part.ToString().ToLowerInvariant();
            var enumValue = ((int) integrity).ToString();
            var texture = new SpriteSpecifier.Rsi(new ResPath($"/Textures/_Shitmed/Interface/Targeting/Status/{name}.rsi"), enumValue);
            button.Texture = _controller.GetTexture(texture);
        }
    }

    private void OnClicked(GUIBoundKeyEventArgs args)
    {
        if (_timing.IsFirstTimePredicted && args.Function == EngineKeyFunctions.Use)
            _controller.GetPartStatusMessage();
    }

    public void SetVisible(bool visible) => this.Visible = visible;

}
